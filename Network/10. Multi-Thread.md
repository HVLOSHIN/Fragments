---
tags:
  - fragment
  - network
text: "[[Network]]"
---

> [!summary]
> 동시처리가 필요하다면 스레드를 추가로 생성해야 한다.
> **단일스레드** - **요청마다 스레드 생성**(스레드 생성비용이 비효율적) - **스레드 풀**  (대세 픽)
> 스레드 풀의 스레드 최대수는 평소 테스트를 통해 스윗스팟을 잘 찾아야 한다.

# Thread
- 애플리케이션 - 프로세스 - 스레드 (가장 작은 단위의 업무를 처리한다)
![[Fragments/Structure & OS/OS/shared resource#^26cc31|공유자원]]
- Java main을 처음 실행하면 main 이라는 이름의 스레드가 실행된다. 
- 스레드는 한번의 하나의 코드 라인만 수행
- 동시처리가 필요하다면 스레드를 추가로 생성해야 한다.

### 단일 스레드
![[0/Excalidraw/Spring HTTP.md#^group=bDKQF2M_dJswZfofsXlYD|900]]


> [!note]+ 웹 서버 단일 스레드 동작 순서
> 1. 클라이언트의 **요청** - **수신** ([[2. IP#TCP/IP 4계층 모델|TCP/IP 프로토콜]]) - **파싱(Parsing)**
> 2. 서블릿 컨테이너 호출 : 웹 서버는 서블릿 컨테이너에게 [[9. Servlet 개념#서블릿의 등장 배경|요청을 위임]]
> 3. 서블릿 처리 : 호출된 서블릿은 요청을 처리한다. (동적 HTML생성, DB접근, 복잡한 계산 등등)
> 4. 응답 생성 : 생성한 HTML을 [[9. Servlet 개념#서블릿 특징|HttpServletResponse]]객체에 담아 웹서버로 반환
> 5. 웹 서버는 서블릿에게 응답을 넘겨받아 HTTP 응답 메시지로 포맷하여 클라이언트에게 전송한다.

^282609

이제 공부한 부분들이 조금씩 연결고리를 갖는거 같다.

### 요청 마다 스레드 생성
![[0/Excalidraw/Spring HTTP.md#^group=zsi6ic89pc8_sUkeWECNb|900]]



장점
- 동시 요청을 처리할 수 있다.
- 리소스(CPU, 메모리)가 허용할 때 까지 처리 가능
- 하나의 스레드가 지연되어도, 나머지 스레드는 정상 동작
단점
- 스레드의 생성비용 - 요청이 올 때 마다 스레드를 생성하면 응답속도가 늦어진다.
- 스레드의 컨텍스트 스위칭 비용 발생 (스레드가 완전히 동시 동작하는 것은 아님)
- 스레드 생성에 제한이 없다. -> 요청이 너무 많다면 서버가 터질 수 있다.

### 스레드 풀
![[0/Excalidraw/Spring HTTP.md#^group=okl_R6HuUgufiI_TIgcpZ|900]]

스레드 풀에 필요한 스레드를 보관해 놓고, 대기 상태로 둔다. 스레드를 요청하면 하나씩 할당해 준다.
- 스레드 사용이 끝나면 다시 대기상태로 들어간다.
- 스레드 풀에는 스레드 수가 정해져 있다. 스레드가 부족하면 요청을 대기하거나 거절당한다. (느려지는것이 과부화로 터지는거 보다는 안전)
- **작업 큐** : 들어온 작업들은 큐에 저장된다. [[Fragments/Structure & OS/OS/shared resource#모니터|이거 아니여?]]

> [!note]
> 참고로 톰캣은 최대 200개의 스레드를 기본 설정으로 갖는다.

> [!note]-   스레드풀과 동기화 도구들의 관계
> 스레드 풀은 내부적으로 뮤텍스, 세마포어와 같은 동기화 도구를 사용하여 안전하게 동작하지만, 
> 개발자의 관점에서는 직접적인 동기화 코드를 작성할 필요가 없다. 
> 스레드 풀은 **더 높은 수준**에서 작업 처리를 관리하는 도구라고 할 수 있다.
>따라서 스레드 풀은 뮤텍스, 세마포어, 모니터 중 어떤 방식이라고 단정하기보다는, 
>이러한 동기화 도구들을 **내부적으로 활용**하여 구현된 고수준의 추상화된 도구라고 보는 것이 더 정확하다.
>
>결론 : 스레드 풀이 아래 동기화 도구들의 방식을 채택할 수 있다.




#### 실무에서의 스레드 풀
WAS의 주요 튜닝 포인트는 최대 스레드 수 (max thread)
- 값이 너무 낮을 경우
  동시요청이 많을 경우 서버 리소스는 여유롭지만, 클라이언트는 응답지연이 발생한다.
- 값이 너무 높을 경우
  동시요청이 많을 경우 CPU, 메모리 리소스 한계로 서버 다운

장애가 발생한다면
- 클라우드 : 일단 서버부터 늘리고, 이후에 튜닝
- 클라우드 아닌 경우 : 걍 열심히 튜닝
  


#### 스레드 갯수 스윗스팟
애플리케이션 로직의 복잡도, CPU, 메모리, IO리소스 상황에 따라 모두 다름
최대한 실제 서비스와 유사한 환경으로 성능 테스트를 해봐야 한다.


### WAS의 멀티스레드 지원
- 멀티스레드에 대한 부분은 [[8. Web, WAS#WAS|WAS]]가 처리
- 개발자가 멀티스레드 관련 코드를 신경쓰지 않아도 됨 - 싱글스레드 프로그래밍을 하듯이 개발할 수 있다.
- 멀티스레드 환경이므로 [[4. Singleton Container#싱글톤 방식의 주의점|싱글톤 객체]] ([[9. Servlet 개념|서블릿]], [[1. SpringBoot 주요 개념#빈| 스프링 빈]])은 주의해서 사용해야 함 - [[3. HTTP#2. 무상태 프로토콜(스테이트리스 stateless)|stateless]]
