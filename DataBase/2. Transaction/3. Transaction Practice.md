---
tags:
  - database
  - fragment
---

# 실습

### [[1. DB Transaction|트랜잭션]] 미사용
```java
@RequiredArgsConstructor  
public class MemberServiceV1 {  
  
    private final MemberRepositoryV1 memberRepository;  
  
    public void accountTransfer(String fromId, String toId, int money) throws SQLException {  
        Member fromMember = memberRepository.findById(fromId);  
        Member toMember = memberRepository.findById(toId);  

		// 계좌이체 로직
        memberRepository.update(fromId, fromMember.getMoney() - money);  
        validation(toMember);  
        memberRepository.update(toId, toMember.getMoney() + money);  
  
    }
    // 예외 발생 로직  
    private static void validation(Member toMember) {  
        if(toMember.getMemberId().equals("ex")) {  
            throw new IllegalStateException("이체 중 예외 발생");  
        }    
    }
}
```
update 메서드는 [[2. JDBC CRUD|여기]]에서 만들었던거 기억나시쥬?

테스트 돌려 봅시다
###### 정상 케이스
```java
class MemberServiceV1Test {  

	// 편하게 쓸려고 상수 설정
    public static final String MEMBER_A = "memberA";  
    public static final String MEMBER_B = "memberB";  
    public static final String MEMBER_EX = "ex";  
  
    private MemberServiceV1 memberService;  
    private MemberRepositoryV1 memberRepository;  

	// 사전 설정
    @BeforeEach  
    void before() {  
        DriverManagerDataSource dataSource = new DriverManagerDataSource(URL, USERNAME, PASSWORD);  
        memberRepository = new MemberRepositoryV1(dataSource);  
        memberService = new MemberServiceV1(memberRepository);  
    } 
    
    // Test 종료시점에 수행 (Finally 느낌?) 
	@AfterEach  
	void after() throws SQLException {  
	    memberRepository.delete(MEMBER_A);  
	    memberRepository.delete(MEMBER_B);  
	    memberRepository.delete(MEMBER_EX);  
	}

    @Test  
    @DisplayName("정상 이체")  
    void accountTransfer() throws SQLException {  
        // given (~이 주어졌을때)  
        Member memberA = new Member(MEMBER_A, 10000);  
        Member memberB = new Member(MEMBER_B, 10000);  
        memberRepository.save(memberA);  
        memberRepository.save(memberB);  
  
        // when (~을 수행하면)  
        memberService.accountTransfer(memberA.getMemberId(), memberB.getMemberId(), 2000);  
  
        // then (~게 된다.)  
        Member findMemberA = memberRepository.findById(memberA.getMemberId());  
        Member findMemberB = memberRepository.findById(memberB.getMemberId());  
  
        Assertions.assertThat(findMemberA.getMoney()).isEqualTo(8000);  
        Assertions.assertThat(findMemberB.getMoney()).isEqualTo(12000);  
    }
}
```

###### 오류가 발생하는 경우
