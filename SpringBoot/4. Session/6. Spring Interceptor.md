---
tags:
  - fragment
  - spring
text: "[[Spring]]"
---
# 스프링 인터셉터
[[5. Servlet Filter|서블릿 필터]]와 마찬가지로 웹과 관련된 **공통 관심사 분리**를 효과적으로 해결할 수 있는 기술이다.
필터는 [[1. Servlet|서블릿]]이 제공하는 기술이라면, 스프링 인터셉터는 스프링 MVC에서 제공하는 기술이다.

> [!note] 스프링 인터셉터 흐름
> HTTP request -> WAS -> Filter -> Servlet -> **Spring Interceptor** -> Controller
  필터와 마찬가지로 적절하지 않은 요청이라고 판단되면 컨트롤러를 호출하지 않을 수 있다.
  또한 인터셉터 체인을 만들 수 도 있다.

- 컨트롤러 호출 직전에 호출된다.
- 스프링 MVC 에서 제공하는 기능이기 때문에, 결국 [[5. MVC Structure#DispatcherServlet|디스패처 서블릿]] 이후에 호출된다.
  -> 스프링 MVC의 시작 지점이 디스패처 서블릿이라고 보면 될듯
- 스프링 인터셉터에도 URL패턴 적용가능 (매우 정밀하게 설정할 수 있다.)

### 인터셉터 인터페이스
기본 구조
```java
public interface HandlerInterceptor {

default boolean preHandle(HttpServletRequest request, 
						  HttpServletResponse response,
						  Object handler) throws Exception {}

default void postHandle(HttpServletRequest request, 
						HttpServletResponse response,
						Object handler, @Nullable ModelAndView modelAndView) 
						throws Exception {}

default void afterCompletion(HttpServletRequest request, 
							 HttpServletResponse response, 
							 Object handler, @Nullable Exception ex) 
							 throws Exception {}
}
```
- `doFilter()` 하나만 제공되는 필터와 달리, 
  인터셉터는 **컨트롤러 호출전후** (**preHandle**, **postHandle**), **요청 완료 이후** (**afterCompletion**) 등으로 세분화 되어있다.
- 필터는 request, response 만 제공했지만, 인터셉터는 어떤 컨트롤러가 호출되는지 **호출정보**도 확인할 수 있다.
- 또한 반환되는 **modelAndView** 응답 정보도 확인할 수 있다.

![[!Resources/Excalidraw/Spring Session.md#^group=gUsEpG8kUf39BdEoK_bUW|1000]]
[[9. Response#요청 매핑 핸들러 어댑터 구조|MVC패턴 기억나시쥬?]]
- preHandle : 컨트롤러 전에 호출 (정확히는 핸들러 어댑터 호출전에 호출)
- postHandle : 컨트롤러 호출 후에 호출 (핸들러 어댑터 호출 이후)
- afterCompletion : 뷰 렌더링 이후 호출

 인터셉터의 의 응답 값이 true이면 다음으로 진행, **false면 진행을 멈춘다**.
[[9. Exception|예외]]가 터졌을 경우 : preHandle, postHandle은 스킵, afterCompletion에서 예외처리를 해주어야 한다.


### Log Interceptor\
```java
@Slf4j  
public class logInterceptor implements HandlerInterceptor {  
    public static final String LOG_ID = "logId";  
  
    @Override  
    public boolean preHandle(HttpServletRequest request, 
						     HttpServletResponse response, Object handler) 
						     throws Exception {  
        String requestURI = request.getRequestURI();  
        String uuid = UUID.randomUUID().toString(); 
        
        request.setAttribute(LOG_ID, uuid);  
        log.info("REQUEST [{}][{}][{}]", uuid,requestURI,handler);  
        return true;  
    }  
    @Override  
    public void postHandle(HttpServletRequest request, 
						  HttpServletResponse response, Object handler, 
						  ModelAndView modelAndView) throws Exception {  
        log.info("postHandle [{}]", modelAndView);  
    }  
    @Override  
    public void afterCompletion(HttpServletRequest request, 
							    HttpServletResponse response, Object handler, 
							    Exception ex) throws Exception {  
        String requestURI = request.getRequestURI();  
        String uuid = (String) request.getAttribute(LOG_ID);  
  
        log.info("RESPONSE [{}][{}][{}]", uuid,requestURI,handler);  
  
        if(ex != null) {  
            log.error(ex.getMessage(), ex);  
        }    
    }
}
```
3개라서 가독성이 좀 빡셈 (어렵지는 않다)
- ==request 에`setAttribute` 를 통해서 값을 저장하면 다른 인터셉터에서 값을 받아서 활용할 수 있다.==
  아주 활용가치가 높아서 강조한번 때림
- 






